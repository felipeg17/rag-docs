name: Integration Tests (Reusable)

on:
  workflow_call:
    inputs:
      ref:
        description: "Git ref to checkout"
        required: true
        type: string
    secrets:
      OPENAI_API_KEY:
        required: true
      COHERE_API_KEY:
        required: true

env:
  PYTHON_VERSION: "3.10.12"
  MINIKUBE_VERSION: "v1.34.0"
  KUBECTL_VERSION: "v1.31.1"
  KUBERNETES_VERSION: "v1.31.0"

jobs:
  integration-tests:
    name: Run Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # ===== SETUP =====
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Setup Minikube
        uses: manusa/actions-setup-minikube@v2.13.0
        with:
          minikube version: ${{ env.MINIKUBE_VERSION }}
          kubernetes version: ${{ env.KUBERNETES_VERSION }}
          github token: ${{ secrets.GITHUB_TOKEN }}
          driver: docker
          start args: '--cpus 2 --memory 4096'

      - name: Verify Minikube
        run: |
          echo "=== Minikube Status ==="
          minikube status

          echo "=== Kubectl Version ==="
          kubectl version --client

          echo "=== Configure kubectl context ==="
          kubectl config use-context minikube

          echo "=== Get Nodes ==="
          kubectl get nodes -o wide

          echo "=== Wait for node to be ready ==="
          kubectl wait --for=condition=ready node --all --timeout=300s

      - name: Setup Skaffold
        run: |
          curl -Lo skaffold https://storage.googleapis.com/skaffold/releases/v2.16.1/skaffold-linux-amd64
          chmod +x skaffold
          sudo mv skaffold /usr/local/bin/
          skaffold version

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Install Python dependencies
        run: uv sync --extra integration

      # ===== BUILD & DEPLOY =====
      - name: Prepare .env files for Docker build
        run: |
          echo "Creating .env files from templates..."
          cp backend.env.template backend.env
          cp frontend.env.template front/frontend.env

      - name: Build Docker images
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "Building images with tag: ${IMAGE_TAG}"

          # Point Docker CLI to Minikube's Docker daemon
          eval $(minikube -p minikube docker-env)

          # Build images directly in Minikube
          docker build -t chromadb-init:${IMAGE_TAG} -f k8s/base/vectordb/Dockerfile k8s/base/vectordb/
          docker build -t rag-docs-backend:${IMAGE_TAG} -f Dockerfile .
          docker build -t rag-docs-frontend:${IMAGE_TAG} -f front/Dockerfile .

          # Verify images
          docker images | grep ${IMAGE_TAG}

      - name: Create Kubernetes secrets
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          COHERE_API_KEY: ${{ secrets.COHERE_API_KEY }}
        run: |
          kubectl create secret generic api-keys \
            --from-literal=OPENAI_API_KEY="${OPENAI_API_KEY}" \
            --from-literal=COHERE_API_KEY="${COHERE_API_KEY}" \
            --namespace=default

      - name: Deploy with Skaffold
        env:
          IMAGE_TAG: ${{ github.sha }}
          CI: true
        run: |
          # Deploy using CI profile
          skaffold run -p ci --default-repo="" --tag=${IMAGE_TAG}

      - name: Wait for deployments to be ready
        run: |
          echo "Waiting for ChromaDB..."
          kubectl wait --for=condition=ready pod -l app=chromadb --timeout=300s

          echo "Waiting for Backend..."
          kubectl wait --for=condition=ready pod -l app=rag-docs-backend --timeout=300s

          echo "Waiting for Frontend..."
          kubectl wait --for=condition=ready pod -l app=rag-docs-frontend --timeout=300s

          # Show pod status
          kubectl get pods

      - name: Setup port forwarding
        run: |
          echo "Setting up port forwarding..."
          kubectl port-forward svc/rag-docs-backend 8106:8106 &
          kubectl port-forward svc/chromadb 9001:8000 &

          # Wait for port forwards to establish
          sleep 10

          # Verify port forwards
          curl -f http://localhost:8106/rag-docs/health || (echo "Backend health check failed" && exit 1)
          curl -f http://localhost:9001/api/v2/heartbeat || (echo "ChromaDB health check failed" && exit 1)

      # ===== RUN TESTS =====
      - name: Run Behave integration tests
        env:
          BACKEND_URL: http://localhost:8106
          CHROMADB_URL: http://localhost:9001
        run: |
          cd tests/behave
          uv run behave --format=pretty --format=json --outfile=behave-results.json

      # ===== CLEANUP & ARTIFACTS =====
      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Collecting pod logs ==="
          mkdir -p logs

          # Get all pod names
          kubectl get pods -o name | while read pod; do
            pod_name=$(basename $pod)
            echo "Collecting logs for $pod_name"
            kubectl logs $pod_name > logs/${pod_name}.log 2>&1 || echo "Failed to get logs for $pod_name"
          done

          # Get events
          kubectl get events --sort-by='.lastTimestamp' > logs/events.log

          # Get pod descriptions
          kubectl describe pods > logs/pod-descriptions.log

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results-${{ github.sha }}
          path: |
            tests/behave/behave-results.json
            logs/

      - name: Cleanup
        if: always()
        run: |
          skaffold delete -p ci || true
          kubectl delete secret api-keys || true

      - name: Generate test summary
        if: always()
        run: |
          echo "## Integration Test Results" >> $GITHUB_STEP_SUMMARY
          if [ -f tests/behave/behave-results.json ]; then
            echo "Test results available in artifacts" >> $GITHUB_STEP_SUMMARY
