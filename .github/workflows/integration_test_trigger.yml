name: Integration Tests

on:
  pull_request:
    types: [labeled, synchronize]
  push:
    branches:
      - main

jobs:
  check-and-run:
    name: Check if tests should run
    runs-on: ubuntu-latest
    outputs:
      should-run: ${{ steps.check.outputs.should-run }}
    steps:
      - name: Check conditions
        id: check
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            echo "Push to main - running tests"
            echo "should-run=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            if [[ "${{ contains(github.event.pull_request.labels.*.name, 'integration-tests') }}" == "true" ]]; then
              echo "PR has integration-tests label - running tests"
              echo "should-run=true" >> $GITHUB_OUTPUT
            else
              echo "PR does not have integration-tests label - skipping"
              echo "should-run=false" >> $GITHUB_OUTPUT
            fi
          fi

  run-integration-tests:
    name: Run Integration Tests
    needs: check-and-run
    if: needs.check-and-run.outputs.should-run == 'true'
    uses: ./.github/workflows/integration-tests-reusable.yml
    with:
      ref: ${{ github.sha }}
    secrets:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      COHERE_API_KEY: ${{ secrets.COHERE_API_KEY }}
